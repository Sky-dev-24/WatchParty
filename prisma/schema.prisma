generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model PlexConnection {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Admin/user identifier (session-based)
  sessionId String @unique

  // Plex auth tokens
  plexToken    String
  plexUsername String

  // Selected server
  selectedServerId  String?
  selectedServerUrl String?

  expiresAt DateTime?

  @@index([sessionId])
}

model Room {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Room identity
  slug     String  @unique
  name     String
  roomCode String? @unique // For private rooms

  // Room type
  isPublic     Boolean @default(true)
  isPersistent Boolean @default(false) // If false, delete when no participants

  // Video source
  videoType     String  // "youtube" | "plex"
  videoId       String  // YouTube video ID or Plex ratingKey
  videoUrl      String? // Full URL for reference
  videoDuration Float?  // Duration in seconds

  // Plex-specific fields
  plexServerUrl String? // For Plex videos
  plexToken     String? // Room creator's Plex token for playback
  plexServerId  String? // Plex server machine identifier

  // Current playback state (host-controlled)
  isPlaying       Boolean  @default(false)
  currentPosition Float    @default(0) // Seconds
  lastUpdated     DateTime @default(now()) // When state last changed

  // Host
  hostId String

  // Relations
  participants Participant[]

  @@index([isPublic])
  @@index([isPersistent])
  @@index([slug])
  @@index([roomCode])
}

model Participant {
  id         String   @id @default(cuid())
  joinedAt   DateTime @default(now())
  lastSeenAt DateTime @default(now())

  // Identity
  displayName String
  sessionId   String @unique // Browser session identifier

  // Permissions
  isHost     Boolean @default(false)
  canControl Boolean @default(false) // Co-host permission

  // Relation
  roomId String
  room   Room   @relation(fields: [roomId], references: [id], onDelete: Cascade)

  // For tracking online status
  isOnline Boolean @default(true)

  @@index([roomId])
  @@index([sessionId])
  @@index([roomId, isOnline])
}

model AuditLog {
  id        String   @id @default(cuid())
  timestamp DateTime @default(now())

  // Event details
  event     String   // e.g., "LOGIN_SUCCESS", "LOGIN_FAILED", "LOGIN_RATE_LIMITED"
  severity  String   @default("INFO") // "INFO", "WARN", "ERROR"

  // Request context
  ipAddress String?
  userAgent String?

  // Additional data (JSON)
  details   String?  // JSON string for flexible additional data

  // Indexes for querying
  @@index([event])
  @@index([timestamp])
  @@index([ipAddress])
}
