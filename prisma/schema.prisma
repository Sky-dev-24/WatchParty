generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Stream {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Stream identification
  slug      String   @unique // URL-friendly identifier (e.g., "new-years-eve-2024")
  title     String

  // Scheduling
  scheduledStart DateTime // When the "broadcast" starts

  // Status
  isActive   Boolean @default(false) // Whether this stream is currently active/visible
  endedAt    DateTime? // If set, stream was force-stopped at this time

  // Playlist & Looping
  loopCount  Int @default(1) // How many times to play the playlist (1-10)
  items      PlaylistItem[]

  // Optional settings
  syncInterval    Int @default(5000)  // How often to sync (ms)
  driftTolerance  Int @default(2)     // Max drift before resync (seconds)

  // Indexes for query performance
  @@index([isActive])
  @@index([scheduledStart])
  @@index([isActive, scheduledStart])
}

model PlaylistItem {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Relation to stream
  streamId  String
  stream    Stream   @relation(fields: [streamId], references: [id], onDelete: Cascade)

  // Mux asset details
  assetId        String  // Mux asset ID
  playbackId     String  // Mux playback ID
  playbackPolicy String  @default("public") // "public" or "signed"
  duration       Float   // Video duration in seconds

  // Order in playlist (0-indexed)
  order     Int

  @@unique([streamId, order])
  @@index([streamId])
}

model AuditLog {
  id        String   @id @default(cuid())
  timestamp DateTime @default(now())

  // Event details
  event     String   // e.g., "LOGIN_SUCCESS", "LOGIN_FAILED", "LOGIN_RATE_LIMITED"
  severity  String   @default("INFO") // "INFO", "WARN", "ERROR"

  // Request context
  ipAddress String?
  userAgent String?

  // Additional data (JSON)
  details   String?  // JSON string for flexible additional data

  // Indexes for querying
  @@index([event])
  @@index([timestamp])
  @@index([ipAddress])
}
